## ACTIVITI

#### 工作流引擎

​    我们可以先通过了解工作流引擎的职责再反过来理解工作流引擎，工作流引擎一般都做两件事情：

​    1.定义流程，也就是给我们提供某种规范来定义规则，以及如何定义一个流程的这种规范，同事我们可以根据工作流引擎提供的相关概念来定义更为复杂的流程，这就是工作流引擎做的第一件事叫做定义流程。

​    2.执行流程，也就是工作流引擎需要解释这个规则，还要负责流程，它相当于流程的调度者，监控每个流程的执行情况，并将流程操作发往下一步，或者根据条件休眠或终止流程的这么一个过程就叫做执行流程。

​    了解完工作流引擎的这两个职责，我相信对于什么是工作流引擎一定已经有了一定的认识了，官方的话来总结一下工作流引擎，工作流引擎为我们提供相关规则概念的定义，给我们提供了相关的API来调用这个引擎去执行流程。流程的操作实际上就是工作流引擎提供相关的api我们去调用它。

 **整个Activiti的生命周期经过了如下的几个步骤：1.流程部署 ， 2.启动流程实例 ， 3.执行流程对象(一个流程实例包含多执行对象) ， 4.完成整个流程**



ACT_GE_* : “GE”代表“General”（通用），用在各种情况下；

ACT_HI_* : “HI”代表“History”（历史），这些表中保存的都是历史数据，比如执行过的流程实例、变量、任务，等等。Activit默认提供了4种历史级别：

Ø  none: 不保存任何历史记录，可以提高系统性能；

Ø  activity：保存所有的流程实例、任务、活动信息；

Ø  audit：也是Activiti的默认级别，保存所有的流程实例、任务、活动、表单属性；

Ø  full：最完整的历史记录，除了包含audit级别的信息之外还能保存详细，例如：流程变量。

对于几种级别根据对功能的要求选择，如果需要日后跟踪详细可以开启full。

 

ACT_ID_* : “ID”代表“Identity”（身份），这些表中保存的都是身份信息，如用户和组以及两者之间的关系。如果Activiti被集成在某一系统当中的话，这些表可以不用，可以直接使用现有系统中的用户或组信息；我这次整合的activiti中没有ID相关的表。

ACT_RE_* : “RE”代表“Repository”（仓库），这些表中保存一些‘静态’信息，如流程定义和流程资源（如图片、规则等）；

ACT_RU_* : “RU”代表“Runtime”（运行时），这些表中保存一些流程实例、用户任务、变量等的运行时数据。Activiti只保存流程实例在执行过程中的运行时数据，并且当流程结束后会立即移除这些数据，这是为了保证运行时表尽量的小并运行的足够快；




#### 部署过程涉及的表逻辑

-- 流程定义信息表 ACT_RE_PROCDEF  存放流程定义的属性信息，部署每个新的流程定义都会在这张表中增加一条记录。注意：当流程定义的key相同的情况下，使用的是版本升级
`SELECT * FROM ACT_RE_PROCDEF WHERE id_='myProcess_1:6:67856d5a-4b47-11ea-ba01-b8763fc3091d';`



-- 部署流程信息表 ACT_RE_DEPLOYMENT，存放流程定义的显示名和部署时间，每部署一次增加一条记录
`SELECT * FROM ACT_RE_DEPLOYMENT WHERE id_='6769f618-4b47-11ea-ba01-b8763fc3091d';_`

   -- 通用的流程定义和流程资源表 ACT_GE_BYTEARRAY 存储流程定义相关的部署信息。即流程定义文档的存放地。每部署一次就会增加两条记录，一条是关于bpmn规则文件的，一条是图片的（如果部署时只指定了bpmn一个文件，activiti会在部署时解析bpmn文件内容自动生成流程图）。两个文件不是很大，都是以二进制形式存储在数据库中。
   `SELECT * FROM ACT_GE_BYTEARRAY WHERE id_='6769f619-4b47-11ea-ba01-b8763fc3091d';`
   `SELECT * FROM act_ge_bytearray WHERE deployment_id_='6769f618-4b47-11ea-ba01-b8763fc3091d';`



表名:ACT_RE_PROCDEF（流程定义：解析表）
流程解析表，解析成功了，在该表保存一条记录。业务流程定义数据表

![1581324257232](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581324257232.png)![1581324286754](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581324286754.png)

注：此表和ACT_RE_DEPLOYMENT是多对一的关系，即，一个部署的bar包里可能包含多个流程定义文件，每个流程定义文件都会有一条记录在ACT_RE_PROCDEF表内，每个流程定义的数据，都会对于ACT_GE_BYTEARRAY表内的一个资源文件和PNG图片文件。和ACT_GE_BYTEARRAY的关联是通过程序用ACT_GE_BYTEARRAY.NAME与ACT_RE_PROCDEF.NAME_完成的，在数据库表结构中没有体现。



#### 启动流程涉及的表逻辑

**ACT_HI_TASKINST**历史任务流程实例信息，核心表

![1581326147742](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581326147742.png)![1581326204996](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581326204996.png)![1581326231429](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581326231429.png)

**ACT_HI_PROCINST** 历史流程实例信息，核心表

![1581328727749](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581328727749.png)

**ACT_HI_ACTINST**历史节点表

历史活动信息。这里记录流程流转过的所有节点，与HI_TASKINST不同的是，taskinst只记录usertask内容。

![1581328918455](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581328918455.png)![1581328946216](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581328946216.png)



**ACT_RU_EXECUTION**运行时流程执行的实例表，核心，我的代办任务查询表

![1581409698970](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581409698970.png)![1581409729988](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581409729988.png)

简单来说流程实例就是根据一次（一条）业务数据用流程驱动的入口，两者之间是一对一的关系。流程引擎会创建一条数据到ACT_RU_EXECUTION表，同时也会根据history的级别决定是否查询相同的历史数据到ACT_HI_PROCINST表。

启动完流程之后业务和流程已经建立了关联关系，第一步结束。



**ACT_RU_TASK**运行时任务数据表，（执行中实时任务）代办任务查询表

![1581409895722](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581409895722.png)![1581409939001](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581409939001.png)![1581409964522](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581409964522.png)



-- 启动流程
-- 历史的任务实例
SELECT * FROM ACT_HI_TASKINST WHERE proc_inst_id_='d07d50c7-4bc7-11ea-aece-b8763fc3091d';
-- 历史的流程实例
SELECT * FROM ACT_HI_PROCINST WHERE proc_inst_id_='d07d50c7-4bc7-11ea-aece-b8763fc3091d';
-- 历史的流程节点实例
SELECT * FROM ACT_HI_ACTINST;
-- 运行时流程执行实例
SELECT * FROM ACT_RU_EXECUTION t WHERE t.id_='d07d50c7-4bc7-11ea-aece-b8763fc3091d';
SELECT * FROM act_ru_execution  WHERE id_='d07d50c8-4bc7-11ea-aece-b8763fc3091d';
-- 运行时任务
SELECT * FROM ACT_RU_TASK;



#### 查看当前人的个人任务

可以通过用户ID查询各种信息，如：任务实例，流程实例等；



#### 完成一个任务

**ACT_HI_IDENTITYLINK**（历史流程人员表）任务参与者数据表。主要存储历史节点参与者的信息。

![1581507195226](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581507195226.png)

**ACT_RU_IDENTITYLINK**运行时用户关系信息，主要存储当前节点参与者的信息,任务参与者数据表。

![1581507597059](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581507597059.png)![1581507623386](C:\Users\Darryl\AppData\Roaming\Typora\typora-user-images\1581507623386.png)

完成一个task会在历史表中插入一些数据，同时会更新运行时流程，运行时任务表。

如此这样就能，简单的让一个工作流实例的运行起来；





BPMN的一些图标的应用：

**StartEvent**：流程的启动节点

**EndEvent**：流程的结束节点

**UserTask**：用户的任务节点，可以通过taskService对该节点做查询，完成等操作

**ManualTask**：手动任务节点，是一个自动执行的过程。手动任务几乎不在程序中做什么事情，只是在流程的历史中留下一点痕迹，表明流程是走过某些节点的。而且这个任务是无法用taskservice查询到的。

**ServiceTask**：当客户有这么一个需求：下一个任务我需要自动执行一些操作，并且这个节点不需要任何的人工干涉，也就是说这个节点是自动化的。那么，这个当前面一个经办人员把任务发送下去的时候，自然而然的下一个节点就会开始马上执行。这个时候。我们就需要使用Activiti工作流的ServiceTask任务。

**parallelGateway**：并行网关，多个任务实例同时进行。

