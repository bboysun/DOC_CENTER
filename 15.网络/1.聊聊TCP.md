## 聊聊TCP

说到TCP协议，不得不说的就是三次握手和四次挥手。那么我们就先说下三次握手和四次挥手，在说之前我们想先了解几个标志位。



SYN：表示创建连接的过程。

ACK：表示是确认过程，1表示是确认信息，0表示不是确认信息。

FIN：表示请求释放连接的过程。



然后，我们先看个图再逐个步骤的解读三次握手。

![1584275414381](image\1584275414381.png)

1. 起初，客户端和服务端都处于closed状态。
2. 客户端发起链接请求，请求中带有SYN=1标志位和seq有序序号保证请求的有序性。（第一次握手，客户端进入syn-sent状态）
3. 服务端收到客户端的连接请求后，将返回发起链接请求的确认信息，带有SYN=1，ACK=1，seq，ack序号。（第二次握手，服务端进入syn-rcvd状态，客户端进入established状态）
4. 客户端在收到服务端的确认消息后，再向服务端发送确认信息，带有ACK=1，seq，ack序号。（第三次握手，服务端进入established状态）

至此就完成了TCP三次握手的过程，这样服务端和客户端都进入了established阶段，就可以进行数据的可靠传输了。



四次挥手又是怎样的呢？我们接着先看图。

![1584276132555](image\1584276132555.png)

客户端和服务端之间数据信息已经交互完成，需要释放连接。

1. 客户端数据都已发送完后，客户端发起释放连接的请求，FIN=1，seq到服务端。（第一次挥手，客户端进入FIN-WAIT-1状态）
2. 服务端收到请求后，需要发送ACK=1，seq，ack到客户端进行确认。（第二次挥手，服务端进入CLOSE-WAIT状态）此时，服务端如果还有数据需要传输，在这个阶段还可向客户端发送数据信息。
3. 客户端收到服务端的确认信息后，进入FIN-WAIT-2状态。
4. 等待服务端所有数据发送完成后，服务端会主动向客户端发送释放连接的请求FIN=1，ACK=1，seq，ack。（第三次挥手，服务端进入LAST-ACK状态）
5. 客户端收到服务端的释放连接的信息后，会发送确认信息ACK=1，seq，ack。（第四次挥手，客户端进入TIME-WAIT状态）。
6. 服务端收到客户端的确认信息后，立即释放资源进入CLOSED状态。
7. 客户端等待了2MSL的时间后，无消息接收，也进入CLOSED状态。



通过上面的解读，现在对TCP三次握手，四次挥手有了完整的认识后，接下来，我们就要思考几个问题了。

**问题1，为什么要三次握手，而不是两次握手就够了呢？**

简单说就是防止超时导致的脏连接。

如果是两次握手机制，我们看下下面的场景会是怎样的结果：

当客户端第一次发送连接请求时，因为网络的原因迟迟没有到达服务端，客户端超时后，认为连接失败会发起第二次连接请求，第二次的连接请求发送到服务端，服务端确认给客户端后完成了两次握手，随后就创建了连接A进行数据传输。一会儿以后，迟到的第一次连接请求也到了服务端，那么服务端收到连接请求后，再次想客户端确认，这个时候服务端和客户端就又完成了两次握手，就又创建了一个连接B进行数据传输。这样的结果不是我们想要的，我们期望超时的那个请求连接不要再去创建连接暂用资源了。

两次握手就会有上面说的问题。那三次握手面对上面的问题是怎样处理的呢？

三次握手，当超时的那个连接请求被确认后返回给了客户端，客户端已经在和服务端进行数据传输的，是不会给服务端发送确认信息的，那么这个迟到的连接请求就不会重复创建连接请求去浪费资源。



**问题2，释放连接时，四次挥手都已经完成后，客户端为什么还要等2MSL时间？**

回答这个问题之前，我们先要理解一下MSL（Maximum segment lifetime）最长报文段的生命时间。

为了保证客户端发送的最后一次确认ACK报文服务端能够真正收到。

试想一种场景，客户端发送了最后一次确认ACK报文，这条报文有可能会丢失，站在服务器端的角度来看，我已经发送了释放连接的确认请求了，迟迟没有收到客户端的确认报文，那么服务端会再次发送释放连接的确认报文，这样客户端就能够在2MSL时间内收到服务端的再次释放连接的确认报文，同时发送确认报文后再次进入TIME-WAIT状态，直到服务端收到了客户端的确认报文后释放连接资源。



**问题3，为什么建立连接是三次握手，释放连接时四次挥手呢？**

创建连接过程三次已经满足了创建连接的可靠性，没必要在浪费资源再次确认一下。至于为什么是四次挥手，因为第一次客户端发送释放资源的报文，只是客户端这边已经没有消息数据需要发送了，但并不代表服务端没有消息接收了。所以需要当服务端都接收了所有的消息报文和发送完所有的消息报文后再次发起释放连接的请求，也就是说分手是两个人的事，需要双方都确认好，你单方面提出分手，我可不会同意的。





